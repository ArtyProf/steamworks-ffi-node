name: Deploy to npm

on:
  push:
    branches: [ main ]
    paths:
      - 'package.json'

permissions:
  id-token: write
  contents: write

jobs:
  # Build native modules for all platforms
  build-native:
    name: Build Native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: macos-14
            platform: darwin
            arch: arm64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    # Linux: Install OpenGL/X11 dev packages
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libx11-dev libxext-dev
    
    # Install npm dependencies
    - name: Install dependencies
      run: npm i
    
    # Build native module
    - name: Build native module
      working-directory: native
      run: npx node-gyp rebuild
      env:
        npm_config_arch: ${{ matrix.arch }}
    
    # Package the built binary
    - name: Package native binary
      shell: bash
      run: |
        mkdir -p prebuilds/${{ matrix.platform }}-${{ matrix.arch }}
        if [ "${{ matrix.platform }}" == "win32" ]; then
          cp native/build/Release/steam-overlay.node prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/
        else
          cp native/build/Release/steam-overlay.node prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/
        fi
        echo "‚úÖ Built for ${{ matrix.platform }}-${{ matrix.arch }}"
        ls -la prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/
    
    # Upload artifact for later use
    - name: Upload prebuild artifact
      uses: actions/upload-artifact@v4
      with:
        name: prebuild-${{ matrix.platform }}-${{ matrix.arch }}
        path: prebuilds/
        retention-days: 1

  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build-native
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install dependencies
      run: npm i
    
    - name: Build TypeScript
      run: npx tsc
    
    - name: Check build output
      shell: bash
      run: |
        if [ -f "dist/index.js" ] && [ -f "dist/index.d.ts" ]; then
          echo "‚úÖ Build files exist"
          ls dist/ 2>/dev/null || dir dist\ || echo "Listing not available"
        else
          echo "‚ùå Required build files missing"
          exit 1
        fi
    
    - name: Verify package can be required
      run: node -e "const steam = require('./dist/index.js'); console.log('‚úÖ Package loads successfully');"

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm i
    
    - name: TypeScript type check
      run: npx tsc --noEmit
    
    - name: Check package.json
      run: |
        node -e "const pkg = require('./package.json'); if (!pkg.main || !pkg.types) throw new Error('Missing main or types in package.json')"

  check-version:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.version_check.outputs.changed }}
      version: ${{ steps.version_check.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check if version changed
      id: version_check
      run: |
        # Get current version
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # Get previous version (from previous commit)
        git checkout HEAD~1 -- package.json 2>/dev/null || echo "No previous commit"
        PREVIOUS_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "none")
        echo "Previous version: $PREVIOUS_VERSION"
        
        # Restore current package.json
        git checkout HEAD -- package.json
        
        # Check if version changed
        if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Version changed: $PREVIOUS_VERSION ‚Üí $CURRENT_VERSION"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Version not changed, skipping publish"
        fi

  publish:
    name: Publish to npm
    needs: [build-native, test, lint, check-version]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.changed == 'true'
    permissions:
      contents: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Update npm
      run: npm install -g npm@latest

    - name: Install dependencies
      run: npm i
    
    - name: Build TypeScript
      run: npm run build
    
    # Download all prebuild artifacts
    - name: Download macOS x64 prebuild
      uses: actions/download-artifact@v4
      with:
        name: prebuild-darwin-x64
        path: prebuilds/
    
    - name: Download macOS arm64 prebuild
      uses: actions/download-artifact@v4
      with:
        name: prebuild-darwin-arm64
        path: prebuilds/
    
    - name: Download Windows x64 prebuild
      uses: actions/download-artifact@v4
      with:
        name: prebuild-win32-x64
        path: prebuilds/
    
    - name: Download Linux x64 prebuild
      uses: actions/download-artifact@v4
      with:
        name: prebuild-linux-x64
        path: prebuilds/
    
    - name: List prebuilds
      run: |
        echo "üì¶ Pre-built binaries:"
        find prebuilds -name "*.node" -type f
    
    - name: Verify build
      shell: bash
      run: |
        echo "Checking build output..."
        
        # Check required files exist
        FILES=("dist/index.js" "dist/index.d.ts" "dist/steam.js" "dist/steam.d.ts")
        for file in "${FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done
        
        # Check types folder exists
        if [ -d "dist/types" ]; then
          echo "‚úÖ dist/types/ folder exists"
          if [ "$(ls -A dist/types)" ]; then
            echo "‚úÖ dist/types/ contains files"
          else
            echo "‚ùå dist/types/ is empty"
            exit 1
          fi
        else
          echo "‚ùå dist/types/ folder missing"
          exit 1
        fi
        
        # Check prebuilds exist
        echo "Checking prebuilds..."
        for platform in darwin-x64 darwin-arm64 win32-x64 linux-x64; do
          if [ -f "prebuilds/$platform/steam-overlay.node" ]; then
            echo "‚úÖ prebuilds/$platform/steam-overlay.node exists"
          else
            echo "‚ö†Ô∏è prebuilds/$platform/steam-overlay.node missing"
          fi
        done
        
        echo "‚úÖ All required files present"
    
    - name: Test package
      run: |
        node -e "const steam = require('./dist/index.js'); console.log('‚úÖ Package loads successfully');"
    
    - name: Publish to npm
      run: npm publish --tag latest --provenance --access public
    
    - name: Create Git tag
      run: |
        VERSION="v${{ needs.check-version.outputs.version }}"
        echo "Creating tag: $VERSION"
        
        git fetch --tags 2>/dev/null || true
        
        if git tag -l | grep -q "^${VERSION}$"; then
          echo "‚ö†Ô∏è Tag $VERSION already exists, skipping creation"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "‚úÖ Tag $VERSION created and pushed"
        fi
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="v${{ needs.check-version.outputs.version }}"
        
        git fetch --tags --unshallow 2>/dev/null || git fetch --tags 2>/dev/null || true
        
        LAST_TAG=$(git tag -l --sort=-version:refname | grep -v "^${VERSION}$" | head -1)
        
        if [ -z "$LAST_TAG" ]; then
          echo "üìù No previous tag found, generating release notes from all history..."
          echo "## üìù What's Changed" > release_notes.md
          echo "" >> release_notes.md
          git log --pretty=format:"- %s (%h)" >> release_notes.md
        else
          echo "üìù Generating release notes from ${LAST_TAG} to current HEAD"
          echo "## üìù What's Changed" > release_notes.md
          echo "" >> release_notes.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "" >> release_notes.md
        
        cat >> release_notes.md << 'EOF'
        ## üñ•Ô∏è Platform Support
        
        This release includes pre-built native binaries for Steam overlay:
        
        | Platform | Architecture | Renderer |
        |----------|--------------|----------|
        | macOS | x64 | Metal |
        | macOS | arm64 (Apple Silicon) | Metal |
        | Windows | x64 | OpenGL |
        | Linux | x64 | OpenGL |
        
        ## üìö Links
        
        - [GitHub Repository](https://github.com/ArtyProf/steamworks-ffi-node)
        - [npm Package](https://www.npmjs.com/package/steamworks-ffi-node)
        - [Documentation](https://github.com/ArtyProf/steamworks-ffi-node#readme)
        
        ---
        EOF
        
        echo "" >> release_notes.md
        
        if [ -n "$LAST_TAG" ]; then
          echo "**Full Changelog**: https://github.com/ArtyProf/steamworks-ffi-node/compare/${LAST_TAG}...${VERSION}" >> release_notes.md
        else
          echo "**Full Changelog**: https://github.com/ArtyProf/steamworks-ffi-node/commits/${VERSION}" >> release_notes.md
        fi
        
        echo "‚úÖ Release notes created"
        cat release_notes.md
    
    # Upload prebuilds to GitHub release
    - name: Create prebuilds archive
      run: |
        tar -czvf prebuilds.tar.gz prebuilds/
        echo "‚úÖ Created prebuilds.tar.gz"
        ls -la prebuilds.tar.gz
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.check-version.outputs.version }}
        name: Release v${{ needs.check-version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          prebuilds.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create summary
      run: |
        echo "## üöÄ Published to npm" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: steamworks-ffi-node" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.check-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: latest" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: https://www.npmjs.com/package/steamworks-ffi-node" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üñ•Ô∏è Pre-built Binaries" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Architecture | Renderer |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | x64 | Metal |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | arm64 | Metal |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | x64 | OpenGL |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | x64 | OpenGL |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üè∑Ô∏è GitHub Release Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: v${{ needs.check-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release**: https://github.com/ArtyProf/steamworks-ffi-node/releases/tag/v${{ needs.check-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "npm install steamworks-ffi-node" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Notify Discord
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"üöÄ steamworks-ffi-node v${{ needs.check-version.outputs.version }} published to npm!\\n\\nüñ•Ô∏è **Platform Support:**\\n- macOS (x64, arm64) - Metal\\n- Windows (x64) - OpenGL\\n- Linux (x64) - OpenGL\\n\\nhttps://www.npmjs.com/package/steamworks-ffi-node\\nRelease notes: https://github.com/ArtyProf/steamworks-ffi-node/releases/tag/v${{ needs.check-version.outputs.version }}\"}" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
